<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cacho (Dudo) ‚Äî Live Rooms</title>
<style>
:root{
  --bg:#0c0f14; --felt:#0b5b3a; --felt2:#063a25; --rail:#1b2433;
  --ink:#eaf2fb; --muted:#93a7bc; --accent:#ffd166; --accent2:#76e2f4;
  --danger:#ff6b6b; --ok:#4ade80; --border:rgba(255,255,255,0.09);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);
  background:radial-gradient(1200px 800px at 120% -10%,#141b23,transparent),linear-gradient(#0c0f14,#0c0f14)}
.wrap{max-width:1200px;margin:0 auto;padding:18px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:10px}
h1{font-size:22px;margin:0}
.badge{font-size:12px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{appearance:none;border:none;cursor:pointer;border-radius:12px;padding:10px 12px;background:#162033;color:var(--ink);border:1px solid var(--border);transition:.2s transform}
.btn:hover{transform:translateY(-1px)}
.btn.primary{background:linear-gradient(180deg,#1c2d48,#152235);border-color:#22344f}
.btn.accent{background:linear-gradient(180deg,#2b3c18,#15240f);border-color:#2f4516;box-shadow:inset 0 0 0 1px rgba(255,209,102,.25);color:#ffe9a8}
.btn.danger{background:linear-gradient(180deg,#3a2020,#261314);border-color:#4a2a2a;color:#ffdede}
.btn.ghost{background:transparent}
.note{font-size:12px;color:var(--muted)}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.panel{padding:14px}
.stack{display:grid;grid-template-columns:1fr;gap:12px}
.divider{height:1px;background:var(--border);margin:10px 0}

/* Table */
#tableWrap{position:relative;width:100%;aspect-ratio:1.6/1;min-height:480px}
.table{position:absolute;inset:0;margin:auto;width:100%;height:100%;display:block}
.feltshell{position:absolute;inset:0;border-radius:44px;background:radial-gradient(120% 120% at 50% 40%,var(--felt),var(--felt2));box-shadow:inset 0 0 0 12px #0a2015,inset 0 0 0 30px #072013,0 20px 70px rgba(0,0,0,.45)}
.rail{position:absolute;inset:-22px;border-radius:52px;background:linear-gradient(180deg,#2a3545,#151c2a);box-shadow:inset 0 0 0 2px rgba(255,255,255,.04)}
.seat{position:absolute;transform:translate(-50%,-50%);width:190px;text-align:center}
.seat .name{font-weight:700}
.seat .cup{margin:6px auto 8px;width:74px;height:74px;border-radius:50%;background:radial-gradient(60px 60px at 50% 40%,#152233,#0c1320);border:1px solid var(--border);display:grid;place-items:center;box-shadow:0 10px 20px rgba(0,0,0,.35);transform:rotate(180deg);cursor:pointer}
.seat .cup:hover{filter:brightness(1.08)}
.seat.eliminated{opacity:.55;filter:grayscale(1)}
.dealer-btn{position:absolute;top:-8px;left:50%;transform:translateX(-50%);background:#f9fafb;color:#111827;border-radius:999px;padding:2px 8px;font-size:11px;border:1px solid rgba(255,255,255,.2)}
.center-bid{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);min-width:240px;min-height:120px;border-radius:24px;background:radial-gradient(120px 80px at 50% 20%,rgba(255,255,255,.08),rgba(255,255,255,.02));border:1px dashed rgba(255,255,255,.14);display:flex;align-items:center;justify-content:center;gap:12px;padding:12px 18px;box-shadow:0 4px 24px rgba(0,0,0,.35),inset 0 0 30px rgba(0,0,0,.25)}
.center-bid .qty{font-size:42px;font-weight:800}.center-bid .facebig{font-size:44px}.center-bid .by{font-size:12px;color:var(--muted)}

/* Bid area */
.bid-box{display:grid;grid-template-columns:1fr;gap:12px;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0f1622}
.bid-row{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
.stepper{display:flex;align-items:center;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.stepper button{padding:10px 12px;border:none;background:#0f1a2a;color:var(--ink);cursor:pointer}
.stepper input{width:76px;text-align:center;border:none;background:#0f1622;color:var(--ink);padding:10px 0;font-weight:700}
.faces{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
.facewrap{display:grid;grid-template-rows:auto auto;gap:8px;justify-items:center}
.facebtn{width:72px;height:72px;border-radius:14px;border:1px solid var(--border);background:#0f1826;display:grid;place-items:center;cursor:pointer;transition:.12s transform}
.facebtn:hover{transform:translateY(-1px)} .facebtn.active{outline:2px solid var(--accent)}
.diepick{font-size:44px;line-height:1;filter:drop-shadow(0 2px 2px rgba(0,0,0,.3))}
.facelabel{font-size:12px;color:var(--muted);pointer-events:none}

/* History */
.history{max-height:260px;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#0f1622}
.history .rowh{display:flex;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid var(--border)}
.history .rowh:last-child{border-bottom:none}

/* Modals */
.modal{position:fixed;inset:0;background:rgba(6,10,14,.65);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
.modal.open{display:flex}
.sheet{width:min(780px,95vw);border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid var(--border);box-shadow:0 20px 60px rgba(0,0,0,.5)}
.sheet .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.sheet .bd{padding:16px}
.curtain{position:fixed;inset:0;background:radial-gradient(600px 400px at 50% -10%,rgba(118,226,244,.15),transparent),rgba(5,10,15,.9);display:none;align-items:center;justify-content:center;z-index:60}
.curtain.open{display:flex}
.curtain .peek{width:min(700px,94vw);border:1px solid var(--border);background:#0d1520;border-radius:16px;padding:16px}
#peekDice{position:relative;height:260px}
input[type="text"], input[type="number"], select, textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1620;color:var(--ink);outline:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="row">
      <h1>üé≤ Cacho (Dudo) ‚Äî Live Rooms</h1>
      <span class="badge">Firebase sync ‚Ä¢ Private dice</span>
    </div>
    <div class="row">
      <button class="btn ghost" id="howToBtn">How to play</button>
      <button class="btn" id="cfgBtn">Firebase config‚Ä¶</button>
      <button class="btn" id="createBtn">Create room</button>
      <button class="btn" id="joinBtn">Join room</button>
      <span class="badge">Room: <b id="roomCode">‚Äî</b></span>
      <button class="btn ghost" id="copyLinkBtn" style="display:none">Copy room link</button>
    </div>
  </header>

  <!-- Seat claim -->
  <section id="seatCard" class="card panel" style="display:none;margin-bottom:12px">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <label style="min-width:120px">Your seat name</label>
        <input id="seatName" type="text" placeholder="e.g., Andrea" style="width:220px"/>
        <button class="btn primary" id="claimBtn">Claim/Update seat</button>
      </div>
      <div class="row">
        <label style="min-width:140px">Turn order</label>
        <select id="turnDir"><option value="cw">Left (clockwise)</option><option value="ccw">Right (counter-clockwise)</option></select>
        <label style="min-width:120px">Dice/player</label>
        <input id="dicePerPlayer" type="number" min="1" max="10" value="5" style="width:80px"/>
        <label style="min-width:80px">Aces wild</label>
        <select id="acesWild"><option value="true">Yes</option><option value="false">No</option></select>
        <label style="min-width:120px">Switch rule</label>
        <select id="switchRule"><option value="perudo">Perudo</option><option value="simple">Simple</option></select>
        <button class="btn" id="applySettingsBtn">Apply (host)</button>
        <button class="btn" id="startBtn">Start round (host)</button>
      </div>
    </div>
    <div class="note" style="margin-top:8px">Anyone can claim a seat name. Only the <b>host</b> (room creator) can start rounds or change table rules.</div>
  </section>

  <!-- Game UI -->
  <section id="gameStack" class="stack" style="display:none">
    <div class="card panel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="note">Current turn</div>
          <div id="turnPlayer" style="font-weight:700;font-size:18px">‚Äî</div>
        </div>
        <div class="row">
          <button class="btn" id="peekBtn">Peek my dice</button>
          <button class="btn" id="hideBtn" style="display:none">Hide</button>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="note">Current bid:</div>
        <div id="currentBidBox" class="badge">‚Äî</div>
        <div class="note" id="minNextNote" style="margin-left:8px"></div>
      </div>
    </div>

    <div id="tableWrap" class="card">
      <div class="feltshell table"></div><div class="rail table"></div>
      <div id="seats"></div>
      <div id="centerBid" class="center-bid"><span class="note">Place the first bid</span></div>
    </div>

    <div class="card panel">
      <div class="note" style="margin-bottom:6px">Make a bid</div>
      <div class="bid-box">
        <div class="bid-row">
          <div><label>Quantity</label><div class="stepper"><button id="qtyMinus">‚àí</button><input id="qtyInput" type="number" min="1" value="1"/><button id="qtyPlus">+</button></div></div>
        </div>
        <div class="faces" id="facePicker"></div>
        <div class="bid-row">
          <button class="btn primary" id="placeBidBtn">Place bid</button>
          <button class="btn danger" id="dudoBtn" disabled>‚ÄúDudo‚Äù</button>
        </div>
      </div>
    </div>

    <div class="card panel">
      <div class="note" style="margin-bottom:6px">Bid history</div>
      <div id="history" class="history" aria-live="polite"></div>
    </div>
  </section>
</div>

<!-- Peek Curtain -->
<div id="curtain" class="curtain" aria-hidden="true">
  <div class="peek">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <div><div class="note">Viewing dice for</div><div id="peekName" style="font-weight:700;font-size:18px">‚Äî</div></div>
      <button class="btn" id="closePeek">Hide</button>
    </div>
    <div id="peekDice"></div>
    <div class="note" style="margin-top:12px">Your dice are private to your seat.</div>
  </div>
</div>

<!-- HowTo -->
<div id="howTo" class="modal" role="dialog" aria-modal="true" aria-labelledby="howHd">
  <div class="sheet">
    <div class="hd"><div id="howHd">How to play</div><button class="btn" id="closeHow">Close</button></div>
    <div class="bd">
      <p><b>Cacho</b> (Dudo/Perudo) live rooms. Create or join a room, claim a seat name, the host sets rules and starts rounds.</p>
      <ol>
        <li>Host clicks <b>Firebase config‚Ä¶</b> and pastes project config; creates Firestore DB.</li>
        <li>Click <b>Create room</b>, share the code/link.</li>
        <li>Each player clicks <b>Join room</b>, enters the code, and <b>Claim/Update seat</b> with their name.</li>
      </ol>
      <p class="note">For security, set Firestore <b>Rules</b> shown in the README section of this file (open source and search for ‚ÄúRULES‚Äù) so players can only read their own dice and only act on their turn.</p>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
const DICE = ['','‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'];
const FACE_NAMES_S = {1:'As',2:'Tonto',3:'Tren',4:'Quadra',5:'Quina',6:'Sexta'};
const FACE_NAMES_P = {1:'Ases',2:'Tontos',3:'Trenes',4:'Quadras',5:'Quinas',6:'Sextas'};
const qs = (s, el=document)=>el.querySelector(s); const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));

// ===== Live room state (remote) =====
let app=null, db=null, auth=null, user=null;
let roomId=null, isHost=false, unsubState=null, unsubSeats=null;
let seats=[]; // [{id,name,uid,diceCount,eliminated,dice:[]}] current snapshot (your dice loaded only for your seat)
let table={ settings:{dicePerPlayer:5,acesWild:true,switchRule:'perudo',turnDir:'cw'}, started:false, startSeat:null, turnSeat:null, prevBid:null, history:[] };

function toast(msg){ const b=document.createElement('div'); b.textContent=msg; b.style.position='fixed'; b.style.bottom='16px'; b.style.left='50%'; b.style.transform='translateX(-50%)'; b.style.background:'#0f1a28'; b.style.border='1px solid var(--border)'; b.style.padding='8px 12px'; b.style.borderRadius='10px'; b.style.zIndex='80'; document.body.appendChild(b); setTimeout(()=>b.remove(),1800); }
function dirStep(){ return table.settings.turnDir==='cw'?1:-1; }
function mod(n,m){ return ((n%m)+m)%m; }

// ===== Firebase init =====
async function ensureFirebase(){
  try{
    const cfg = JSON.parse(localStorage.getItem('cacho_fb_cfg')||'null');
    if(!cfg) throw new Error('No Firebase config found. Click Firebase config‚Ä¶');
    if(!app){ app=firebase.initializeApp(cfg); auth=firebase.auth(); db=firebase.firestore(); await auth.signInAnonymously(); user=auth.currentUser; }
    return true;
  }catch(e){ console.error(e); toast(e.message); return false; }
}

// ===== Rooms =====
function randCode(n=6){ const a='ABCDEFGHJKMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<n;i++) s+=a[Math.floor(Math.random()*a.length)]; return s; }
function roomRef(){ return db.collection('cacho_live_rooms').doc(roomId); }
function seatsRef(){ return roomRef().collection('seats'); }
function mySeat(){ return seats.find(s=>s.uid===user?.uid); }
function seatById(id){ return seats.find(s=>s.id===id); }

async function createRoom(){
  if(!await ensureFirebase()) return;
  roomId = randCode(); isHost=true; qs('#roomCode').textContent=roomId; qs('#copyLinkBtn').style.display='inline-block';
  await roomRef().set({
    createdAt:Date.now(),
    hostUid:user.uid,
    settings: table.settings,
    started:false, startSeat:null, turnSeat:null, prevBid:null, history:[]
  });
  subscribeRoom();
  toast('Room created');
}
async function joinRoomPrompt(){
  if(!await ensureFirebase()) return;
  const code = prompt('Enter room code'); if(!code) return;
  await joinRoom(code.trim().toUpperCase());
}
async function joinRoom(code){
  roomId=code; isHost=false; qs('#roomCode').textContent=roomId; qs('#copyLinkBtn').style.display='inline-block';
  subscribeRoom();
  toast('Joined '+roomId);
}
function subscribeRoom(){
  qs('#seatCard').style.display='block';
  qs('#gameStack').style.display='grid';
  unsubState && unsubState(); unsubSeats && unsubSeats();
  unsubState = roomRef().onSnapshot(snap=>{
    const d=snap.data(); if(!d) return;
    table.settings = d.settings || table.settings;
    table.started = !!d.started; table.startSeat=d.startSeat||null; table.turnSeat=d.turnSeat||null; table.prevBid=d.prevBid||null; table.history=d.history||[];
    renderAll();
  });
  unsubSeats = seatsRef().onSnapshot(async col=>{
    const temp = [];
    for(const doc of col.docs){
      const data = doc.data();
      // For privacy, only the seat owner fetches dice
      let dice=null;
      if(data.uid===user?.uid){
        const seatDoc = await seatsRef().doc(doc.id).get();
        const sd = seatDoc.data();
        dice = sd?.dice || null;
      }
      temp.push({id:doc.id, name:data.name, uid:data.uid, diceCount:data.diceCount, eliminated:!!data.eliminated, dice});
    }
    seats=temp; renderAll();
  });
}

// ===== UI actions =====
qs('#cfgBtn').onclick=()=>{
  const existing = localStorage.getItem('cacho_fb_cfg') || '{\n  "apiKey": "",\n  "authDomain": "",\n  "projectId": ""\n}';
  const txt = prompt('Paste your Firebase Web App config (JSON)', existing);
  if(!txt) return;
  try{ const cfg=JSON.parse(txt); localStorage.setItem('cacho_fb_cfg', JSON.stringify(cfg)); toast('Saved Firebase config'); }catch(e){ toast('Invalid JSON'); }
};
qs('#createBtn').onclick=createRoom;
qs('#joinBtn').onclick=joinRoomPrompt;
qs('#copyLinkBtn').onclick=async()=>{
  const url = location.origin+location.pathname+'#room='+roomId;
  try{ await navigator.clipboard.writeText(url); toast('Room link copied'); }catch(e){ prompt('Copy room link:', url); }
};

// Claim/update seat
qs('#claimBtn').onclick=async()=>{
  if(!roomId){ toast('Join or create a room first'); return; }
  const name = (qs('#seatName').value||'').trim(); if(!name){ toast('Enter a seat name'); return; }
  // Find existing seat by uid or create new
  const my = mySeat();
  if(my){
    await seatsRef().doc(my.id).set({ name }, {merge:true});
  }else{
    const sDoc = await seatsRef().add({
      name, uid:user.uid, diceCount: table.settings.dicePerPlayer, eliminated:false
    });
    // Seed private dice for new seat
    const dice = Array.from({length:table.settings.dicePerPlayer}, ()=>1+Math.floor(Math.random()*6));
    await seatsRef().doc(sDoc.id).set({ dice }, { merge:true });
  }
  toast('Seat saved');
};

// Host settings + start
qs('#applySettingsBtn').onclick=async()=>{
  if(!isHost){ toast('Only host can change rules'); return; }
  table.settings.dicePerPlayer = clamp(parseInt(qs('#dicePerPlayer').value,10)||5,1,10);
  table.settings.acesWild = qs('#acesWild').value==='true';
  table.settings.switchRule = qs('#switchRule').value;
  table.settings.turnDir = qs('#turnDir').value;
  await roomRef().set({ settings: table.settings }, { merge:true });
  toast('Settings updated');
};
qs('#startBtn').onclick=async()=>{
  if(!isHost){ toast('Only host can start'); return; }
  // roll new dice for everyone
  const col = await seatsRef().get();
  let firstSeatId=null;
  for(const d of col.docs){
    const data=d.data();
    const dice = Array.from({length:data.diceCount||table.settings.dicePerPlayer}, ()=>1+Math.floor(Math.random()*6));
    await seatsRef().doc(d.id).set({ dice, eliminated:false, diceCount:data.diceCount||table.settings.dicePerPlayer }, { merge:true });
    if(!firstSeatId) firstSeatId=d.id;
  }
  await roomRef().set({ started:true, startSeat:firstSeatId, turnSeat:firstSeatId, prevBid:null, history:[] }, { merge:true });
  toast('Round started');
};

// Bidding
qs('#qtyMinus').onclick=()=>{ const i=qs('#qtyInput'); i.value=Math.max(1,(parseInt(i.value,10)||1)-1); updateFaceLabels(); };
qs('#qtyPlus').onclick=()=>{ const i=qs('#qtyInput'); const max=seats.filter(s=>!s.eliminated).reduce((sum,s)=>sum+s.diceCount,0)||1; i.value=Math.min(max,(parseInt(i.value,10)||1)+1); updateFaceLabels(); };
qs('#qtyInput').addEventListener('input',updateFaceLabels);

function labelFor(face, q){ return (q>=2?FACE_NAMES_P:FACE_NAMES_S)[face]; }
function renderFacePicker(){
  const fp = qs('#facePicker'); fp.innerHTML='';
  const q = parseInt(qs('#qtyInput').value,10)||1;
  for(let f=1; f<=6; f++){
    const wrap=document.createElement('div'); wrap.className='facewrap';
    const btn=document.createElement('button'); btn.className='facebtn'+(f===2?' active':''); btn.dataset.face=f; btn.innerHTML=`<div class="diepick">${DICE[f]}</div>`;
    btn.onclick=()=>{ qsa('.facebtn', fp).forEach(x=>x.classList.remove('active')); btn.classList.add('active'); };
    const lab=document.createElement('div'); lab.className='facelabel'; lab.setAttribute('data-lab', String(f)); lab.textContent = labelFor(f,q);
    wrap.appendChild(btn); wrap.appendChild(lab); fp.appendChild(wrap);
  }
}
function updateFaceLabels(){ const q = parseInt(qs('#qtyInput').value,10)||1; qsa('.facelabel').forEach(l=>{ const f=parseInt(l.getAttribute('data-lab'),10); l.textContent = labelFor(f,q); }); }

function isValidRaise(prev,next){
  if(!prev) return next.qty>=1 && next.face>=1 && next.face<=6;
  const aces=table.settings.acesWild, sw=table.settings.switchRule;
  if(sw==='perudo' && aces){
    if(prev.face!==1 && next.face===1) return next.qty >= Math.ceil(prev.qty/2);
    if(prev.face===1 && next.face!==1) return next.qty >= prev.qty*2;
  }
  if(prev.face===next.face) return next.qty > prev.qty;
  return next.qty >= prev.qty && next.face > prev.face;
}

qs('#placeBidBtn').onclick=async()=>{
  if(!roomId){ toast('Join or create a room'); return; }
  const mine = mySeat(); if(!mine){ toast('Claim a seat name first'); return; }
  if(table.turnSeat !== mine.id){ toast('It is not your turn'); return; }
  const qty = parseInt(qs('#qtyInput').value,10)||1;
  const face = parseInt(qs('.facebtn.active')?.dataset.face||'0',10);
  if(!face){ toast('Pick a face'); return; }
  const bid = { qty, face, by: mine.id, byName: mine.name, at: Date.now() };
  if(!isValidRaise(table.prevBid, bid)){ toast('Invalid raise'); return; }
  const nextSeatId = nextAliveSeat(mine.id);
  const history = (table.history||[]).concat([{type:'bid', ...bid}]);
  await roomRef().set({ prevBid: { qty, face, by: mine.id, byName: mine.name }, turnSeat: nextSeatId, history }, { merge:true });
};
qs('#dudoBtn').onclick=async()=>{
  if(!roomId){ toast('Join or create a room'); return; }
  const mine=mySeat(); if(!mine){ toast('Claim a seat'); return; }
  if(table.turnSeat !== mine.id){ toast('It is not your turn'); return; }
  if(!table.prevBid){ toast('No bid to doubt'); return; }
  // Count face across all seats‚Äô dice
  const face = table.prevBid.face;
  const aces=table.settings.acesWild;
  const col=await seatsRef().get(); let total=0;
  for(const d of col.docs){
    const sd=d.data();
    if(sd.eliminated) continue;
    const dice = sd.dice || [];
    for(const pip of dice){
      if(pip===face) total++; else if(aces && face!==1 && pip===1) total++;
    }
  }
  const bidderId = table.prevBid.by;
  const holds = total >= table.prevBid.qty;
  const loserId = holds ? mine.id : bidderId;
  // remove a die
  const loserSnap = await seatsRef().doc(loserId).get();
  const loser = loserSnap.data();
  const newCount = Math.max(0, (loser.diceCount||5) - 1);
  const eliminated = newCount===0;
  await seatsRef().doc(loserId).set({ diceCount:newCount, eliminated }, { merge:true });
  // reroll all survivors
  const col2=await seatsRef().get();
  for(const d of col2.docs){
    const sd=d.data(); if(sd.eliminated) continue;
    const dice = Array.from({length:sd.diceCount||0}, ()=>1+Math.floor(Math.random()*6));
    await seatsRef().doc(d.id).set({ dice }, { merge:true });
  }
  // compute next start
  const nextStart = eliminated ? nextAliveSeat(loserId) : loserId;
  const aliveCount = (await seatsRef().where('eliminated','==',false).get()).size;
  let newState={ prevBid:null, turnSeat: nextStart, startSeat: nextStart };
  const hist=(table.history||[]).concat([{type:'dudo', by: mine.id, byName: mine.name, at: Date.now()}, {type:'round', text: holds? `Bid holds (${total}). ${mine.name} loses a die.`:`Bid fails (${total}). ${table.prevBid.byName} loses a die.`}]);
  if(aliveCount<=1){
    // declare winner
    const still = (await seatsRef().where('eliminated','==',false).get()).docs[0];
    const winnerName = still? (still.data().name||'Someone') : 'No one';
    newState.started=false;
    table.history = hist.concat([{type:'round', text:`üèÜ ${winnerName} wins the game!`}]);
  }else{
    table.history = hist;
  }
  await roomRef().set(Object.assign({ history: table.history }, newState), { merge:true });
};

function nextAliveSeat(fromId){
  if(seats.length===0) return null;
  const idx = seats.findIndex(s=>s.id===fromId);
  const step = dirStep();
  for(let k=1;k<=seats.length;k++){
    const j = mod(idx + step*k, seats.length);
    if(!seats[j].eliminated) return seats[j].id;
  }
  return fromId;
}

// ===== Rendering =====
function renderAll(){
  renderSeats();
  renderTurn();
  renderBidUI();
  renderHistory();
  renderCurrentBid();
}
function renderSeats(){
  const host=qs('#seats'); host.innerHTML='';
  const N=seats.length; if(N===0) return;
  const turnIndex = Math.max(0, seats.findIndex(s=>s.id===table.turnSeat));
  for(let i=0;i<N;i++){
    const p=seats[i], isTurn=(p.id===table.turnSeat);
    const k=(i - turnIndex + N) % N;
    const theta = Math.PI/2 + (k * (2*Math.PI/N)) * (table.settings.turnDir==='cw'?1:-1);
    const r=42; const x=50 + r*Math.cos(theta); const y=50 + r*Math.sin(theta);
    const seat=document.createElement('div'); seat.className='seat'+(p.eliminated?' eliminated':''); seat.style.left=x+'%'; seat.style.top=y+'%';
    seat.innerHTML=`<div class="dealer-btn" style="display:${p.id===table.startSeat?'inline-block':'none'}">BTN</div><div class="name">${p.name||'‚Äî'}${isTurn?' <span class="badge">Turn</span>':''}</div><div class="cup" data-seat="${p.id}" title="Click to peek your dice">üç∂</div>`;
    host.appendChild(seat);
  }
  qsa('.seat .cup', host).forEach(c=>{
    c.onclick=async()=>{
      if(!user) return;
      const sid=c.dataset.seat;
      const seat=seats.find(s=>s.id===sid);
      if(seat.uid!==user.uid){ toast('You can only peek your own dice'); return; }
      const doc = await seatsRef().doc(sid).get();
      const dice = (doc.data()||{}).dice||[];
      openPeek(seat.name||'You', dice);
    };
  });
}
function renderTurn(){
  const curr = seatById(table.turnSeat);
  qs('#turnPlayer').textContent = curr? (curr.name + (curr.eliminated?' (out)':'')) : '‚Äî';
  const mine = mySeat();
  qs('#dudoBtn').disabled = !table.prevBid || !(mine && mine.id===table.turnSeat);
}
function renderBidUI(){
  renderFacePicker(); updateFaceLabels();
}
function renderHistory(){
  const h=qs('#history');
  if(!table.history || table.history.length===0){ h.innerHTML='<div class="rowh"><span class="note">No bids yet</span></div>'; return; }
  h.innerHTML = table.history.map(item=> item.type==='bid' ? `<div class="rowh">üó£Ô∏è <b>${item.byName||'Seat'}</b> bids <b>${item.qty}</b> √ó <span style="font-size:18px">${DICE[item.face]}</span></div>` : item.type==='dudo' ? `<div class="rowh">‚ùó <b>${item.byName||'Seat'}</b> calls <b>Dudo</b>!</div>` : `<div class="rowh">üîî ${item.text}</div>` ).join('');
  h.scrollTop=h.scrollHeight;
}
function minNextBidText(){
  if(!table.prevBid) return 'First bid can be any quantity and face.';
  const b=table.prevBid; const sw=table.settings.switchRule; const aces=table.settings.acesWild;
  if(sw==='perudo' && aces){
    if(b.face!==1) return `‚â• same quantity with higher face, or > quantity. To ‚öÄ: ‚â• ${Math.ceil(b.qty/2)} ‚öÄ.`;
    return `From ‚öÄ to 2‚Äì6: ‚â• ${b.qty*2} of that face.`;
  }
  return '‚â• same quantity & higher face, or > quantity.';
}
function renderCurrentBid(){
  const box=qs('#currentBidBox'); const center=qs('#centerBid');
  if(!table.prevBid){ box.textContent='‚Äî'; center.innerHTML='<span class="note">Place the first bid</span>'; }
  else{
    const html = `${(seatById(table.prevBid.by)||{}).name||'Seat'}: <b>${table.prevBid.qty}</b> √ó <span style="font-size:20px">${DICE[table.prevBid.face]}</span>`;
    box.innerHTML=html; center.innerHTML=`<span class="qty">${table.prevBid.qty}</span> <span class="facebig">${DICE[table.prevBid.face]}</span> <span class="by">by</span> <b>${table.prevBid.byName||'Seat'}</b>`;
  }
  qs('#minNextNote').textContent=minNextBidText();
}

// Peek view: circular placement
function openPeek(name,dice){
  qs('#peekName').textContent=name;
  const host=qs('#peekDice'); host.innerHTML='';
  const n=dice.length, cx=180, cy=130, R=90;
  for(let i=0;i<n;i++){
    const ang=(-Math.PI/2)+(i*(2*Math.PI/n));
    const x=cx+R*Math.cos(ang), y=cy+R*Math.sin(ang);
    const el=document.createElement('div'); el.className='die'; el.style.position='absolute'; el.style.left=(x-22)+'px'; el.style.top=(y-22)+'px'; el.style.fontSize='44px'; el.textContent=DICE[dice[i]];
    host.appendChild(el);
  }
  qs('#curtain').classList.add('open'); qs('#curtain').setAttribute('aria-hidden','false');
}
qs('#closePeek').onclick=()=>{ qs('#curtain').classList.remove('open'); qs('#curtain').setAttribute('aria-hidden','true'); };
qs('#peekBtn').onclick=async()=>{
  const mine=mySeat(); if(!mine){ toast('Claim a seat'); return; }
  const doc = await seatsRef().doc(mine.id).get();
  openPeek(mine.name||'You', (doc.data()||{}).dice||[] );
};
qs('#hideBtn').onclick=()=>{ qs('#curtain').classList.remove('open'); qs('#curtain').setAttribute('aria-hidden','true'); };

// HowTo modal
qs('#howToBtn').onclick=()=>qs('#howTo').classList.add('open');
qs('#closeHow').onclick=()=>qs('#howTo').classList.remove('open');

// Auto-join via hash
(function(){ const m=location.hash.match(/room=([A-Z0-9]+)/i); if(m){ const code=m[1].toUpperCase(); ensureFirebase().then(()=>joinRoom(code)); }})();

// Build face picker on load
renderFacePicker(); updateFaceLabels();
function renderAll(){ renderSeats(); renderTurn(); renderBidUI(); renderHistory(); renderCurrentBid(); }

</script>

<!--
FIREBASE FIRESTORE SECURITY RULES (paste into Firestore -> Rules)
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /cacho_live_rooms/{roomId} {
      allow read: if true;
      allow write: if request.auth != null
                   && request.resource.data.keys().hasOnly(['createdAt','hostUid','settings','started','startSeat','turnSeat','prevBid','history'])
                   && (request.auth.uid == resource.data.hostUid); // only host updates table doc
      match /seats/{seatId} {
        allow read: if true; // everyone sees names/diceCount/eliminated; dice field is filtered client-side
        allow write: if request.auth != null
                     && ( // seat owner can update own seat (name, dice rolled by serverless host)
                          (request.resource.data.uid == request.auth.uid)
                        );
      }
    }
  }
}
-->
</body>
</html>
